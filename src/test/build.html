<html>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<script src="/app.js"></script>
<script>

var DOMAINS = {API:'https://admin.abroadwith.com'}

var newUser = {
  firstName:"John",
  lastName:"Doe",
  email:"simple@email.com",
  password:"rightPASS",
  userKnownLanguages:[{language:"ENG",level:"NATIVE"}],
  birthDate:"1990-01-01"
};

var loginObj = {
  email:"simple@email.com",
  password:"rightPASS"
};

var userProfile = {
  firstName:"John",
  lastName:"Doe",
  gender:"MALE",
  birthDate:"1981-03-04",
  userKnownLanguages:[
    {language:"ENG",level:"PROFICIENT"},
    {language:"POR",level:"NATIVE"}
  ],
  userLearningLanguages:[
    {language:"SWE",level:"BEGINNER"},
    {language:"DEU",level:"ADVANCED"}
  ],
  phoneNumber:"+4915112262903",
  email:"simple@email.com",
  location:"Berlin, Germany",
  occupation:"Engineer",
  photo:"/static/user/photo.jpg",
  emergencyContact:{
    name:"Matheus",
    phone:"123541234",
    email:"matheus@abroadwith.com",
    relationship:"Myself"
  },
  notifications:{
    email:{reminders:true,promotion:true},
    sms:{all:true}
  },
  aboutMe:"Just a regular guy.",
  education:"TU Berlin",
  grewUp:"Curitiba, Brazil",
  favBook:"Harry Potter",
  favFilm:"21 Grams",
  amazingFeat:"Archery",
  canShare:"Cooking",
  interests:["MOVIES","READING"],
  countriesVisited:'["CZ","UK","FR"]',
  countriesLived:'["DE","BR"]',
  address:{
    street:"Torstr 225",
    complement:"D",
    city:"Berlin",
    country:"DE",
    neighbourhood:"Mitte",
    zipCode:"10115",
    state:"Berlin",
    lat: 52.533332,
    lng: 13.3930395
  }
}

var newHome = {
  basics: {
    homeType: "FLAT",
    SAFETY: ["FIRST_AID"],
    AMENITIES: ["TV","AIR_CONDITIONING","ESSENTIALS","CABLE_TV"],
    EXTRAS: ["FREE_PARKING_NEARBY","DRYER","GYM"],
    PREFERENCES: ["FAMILY_FRIENDLY","PETS_LIVE_IN_THE_HOUSE"],
    FOOD_OPTION: ["VEGETARIAN","VEGAN"],
    family: true
  },
  immersions: {
    stay: {
      isActive: true,
      languagesOffered: ["ENG"],
      hours: 7
    },
    tandem: {
      isActive: true,
      languagesOffered: ["ENG"],
      hours: 8,
      languagesInterested: [
        {
          discount: 30,
          lang: "DEU"
        }
      ]
    },
    teacher: {
      isActive: true,
      languagesOffered: ["ENG"],
      certifications: [],
      packages: [5,15],
      hourly: 17
    }
  },
  description: {
    summary: "This is a simple home.",
    rules: "No bad behaviours please!",
    neighbourhood: "Nice supermarket around.",
    video: "https://www.youtube.com/watch?v=jS8IZcx7tJY"
  },
  rooms:[],
  photos:["/static/home/1.jpg","/static/home/2.jpg"],
  pricing: {
    currency: "EUR",
    discounts: [],
    extras: [{
      service: "LAUNDRY",
      cost: 10
    }]
  },
  location: {
    street: "Torstr 225",
    complement: "D",
    city: "Berlin",
    country: "DE",
    neighbourhood: "Mitte",
    zipCode: "10115",
    state: "Berlin",
    lat: 52.533332,
    lng: 13.3930395
  }
}

var room1 = {
  name:"Living room",
  description:"Just my living room.",
  vacancies:1,
  shared:false,
  bed:"SINGLE_BED",
  facilities:["BEDSIDE_LOCKER"]
};

var room2 = {
  name:"Bedroom",
  description:"My bedroom.",
  vacancies:1,
  shared:false,
  bed:"SINGLE_BED",
  facilities:["HAIR_DRYER","MIRROR","HANGERS"]
};


var getHome = function(newurl){
  $.ajax({
    type: "GET",
    url: newurl,
    contentType: "application/json",
    beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('JWT'))},
    success: function (body,text,response) {
      $('#status').append("<h1>Get home</h1>");
      $('#status').append('<br/> Request:'+newurl);
      $('#status').append('<br/>'+response.status);
      $('#status').append('<br/> Response:'+JSON.stringify(body));
    }
  });
}

var updateHome = function(newurl){

  $.ajax({
    type: "POST",
    url: newurl,
    contentType: "application/json",
    data: JSON.stringify(newHome),
    beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('JWT'))},
    success: function (body,text,response) {
      $('#status').append("<h1>Update home</h1>");
      $('#status').append('<br/> Request:'+JSON.stringify(newHome));
      $('#status').append('<br/>'+response.status + " - "+response.getResponseHeader('Location'));
      $('#status').append('<br/> Response:'+JSON.stringify(body));

      getHome(newurl)
    }
  });
}

var addRooms = function(newurl){
  $.ajax({
    type: "POST",
    url: newurl,
    contentType: "application/json",
    data: JSON.stringify(room1),
    beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('JWT'))},
    success: function (body,text,response) {
      $('#status').append("<h1>Update home</h1>");
      $('#status').append('<br/> Request:'+JSON.stringify(room1));
      $('#status').append('<br/>'+response.status + " - "+response.getResponseHeader('Location'));
      $('#status').append('<br/> Response:'+JSON.stringify(body));

      $.ajax({
        type: "POST",
        url: newurl,
        contentType: "application/json",
        data: JSON.stringify(room2),
        beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('JWT'))},
        success: function (body,text,response) {
          $('#status').append("<h1>Update home</h1>");
          $('#status').append('<br/> Request:'+JSON.stringify(room2));
          $('#status').append('<br/>'+response.status + " - "+response.getResponseHeader('Location'));
          $('#status').append('<br/> Response:'+JSON.stringify(body));

          getHome(newurl)
        }
      });
    }
  });
}

var updateComplete = function(newurl){

  $.ajax({
    type: "GET",
    url: newurl,
    contentType: "application/json",
    beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('JWT'))},
    success: function (body,text,response) {
      $('#status').append("<h1>Get home</h1>");
      $('#status').append('<br/> Request:'+newurl);
      $('#status').append('<br/>'+response.status);
      $('#status').append('<br/> Response:'+JSON.stringify(body));

      /*room1.price = 30;
      room1.id = body.rooms[0].id;
      room2.price = 50;
      room2.id = body.rooms[1].id;
      newHome.rooms.push(room1);
      newHome.rooms.push(room2);*/
      if(body.rooms.length > 0){
        body.rooms[0].price = 30.0;
        body.rooms[0].img = "/static/room/1.jpg";
        body.rooms[1].price = 50.0;
        body.rooms[1].img = "/static/room/2.jpg";
        newHome.rooms = body.rooms;
        $.ajax({
          type: "POST",
          url: newurl,
          contentType: "application/json",
          data: JSON.stringify(newHome),
          beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('JWT'))},
          success: function (body,text,response) {
            $('#status').append("<h1>Update home</h1>");
            $('#status').append('<br/> Request:'+JSON.stringify(newHome));
            $('#status').append('<br/>'+response.status + " - "+response.getResponseHeader('Location'));
            $('#status').append('<br/> Response:'+JSON.stringify(body));

            getHome(newurl);
          }
        });
      }
      else{
        updateHome(newurl);
        addRooms(newurl+"/rooms");
        getHome(newurl)
      }
    }
  });

}

var getUser = function(token){
  $.ajax({
    type: "GET",
    url: DOMAINS.API+'/users/'+token.rid,
    beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('JWT'))},
    success: function (body,text,response) {
      $('#status').append("<h1>Get User</h1>");
      $('#status').append('<br/> Request:'+JSON.stringify(newHome));
      $('#status').append('<br/>'+response.status + " - "+response.getResponseHeader('Location'));
      $('#status').append('<br/> Response:'+JSON.stringify(body));

      if(!token.hid){
        $.ajax({
          type: "POST",
          url: DOMAINS.API+'/users/'+token.rid+'/homes',
          contentType: "application/json",
          data: JSON.stringify("{}"),
          beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('JWT'))},
          success: function (body,text,response) {
            $('#status').append("<h1>Create home</h1>");
            $('#status').append('<br/> Request:{}');
            $('#status').append('<br/>'+response.status + " - "+response.getResponseHeader('Location'));
            $('#status').append('<br/> Response:'+body);

            updateHome(response.getResponseHeader('Location'));
            addRooms(response.getResponseHeader('Location')+"/rooms");
          }
        });
      }
      else{
        updateComplete(DOMAINS.API+'/users/'+token.rid+'/homes/'+token.hid);
      }
    }
  });
}

var updateUser = function(token){
  $.ajax({
    type: "POST",
    url: DOMAINS.API+'/users/'+token.rid,
    contentType: "application/json",
    data: JSON.stringify(userProfile),
    beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.getItem('JWT'))},
    success: function (body,text,response) {
      $('#status').append("<h1>Update User</h1>");
      $('#status').append('<br/> Request:'+JSON.stringify(newHome));
      $('#status').append('<br/>'+response.status + " - "+response.getResponseHeader('Location'));
      $('#status').append('<br/> Response:'+JSON.stringify(body));

      getUser(token);
    }
  });
}

$.ajax({
  type: "POST",
  url: DOMAINS.API + '/users',
  data: JSON.stringify(newUser),
  contentType: "application/json",
  processData: false,
  complete: function(response){
    $('#status').append("<h1>Create user</h1>");
    $('#status').append('<br/> Request:'+JSON.stringify(newUser));
    $('#status').append('<br/>'+response.status + " - "+response.getResponseHeader('Location'));
    $('#status').append('<br/> Response:'+response.responseText);
    $.ajax({
      type: "POST",
      url: DOMAINS.API+'/users/login',
      contentType: "application/json",
      data: JSON.stringify(loginObj),
      xhrFields: {withCredentials: true},
      success: function(JWT,text,response) {
        $('#status').append("<h1>Login user</h1>");
        $('#status').append('<br/> Request:'+JSON.stringify(loginObj));
        $('#status').append('<br/>'+response.status);
        $('#status').append('<br/> Response:'+atob(JWT.token.split('.')[1]));

        localStorage.setItem('JWT', JWT.token);

        var token = JSON.parse(atob(localStorage.getItem('JWT').split('.')[1]));

        updateUser(token);
      }
    });
  }
});
</script>

<!--
  Below we include the Login Button social plugin. This button uses
  the JavaScript SDK to present a graphical Login button that triggers
  the FB.login() function when clicked.
-->

<fb:login-button scope="public_profile,email" onlogin="checkLoginState();">
</fb:login-button>

<div id="status">
</div>

</body>
</html>
